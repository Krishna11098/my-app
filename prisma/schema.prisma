// schema.prisma
datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// ====================
// ENUMS
// ====================

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum RentalPeriodUnit {
  HOUR
  DAY
  WEEK
  MONTH
  CUSTOM
}

enum ProductType {
  GOODS
  SERVICE
}

enum PriceUnit {
  PER_HOUR
  PER_DAY
  PER_WEEK
  PER_MONTH
  PER_UNIT
}

enum DeliveryMethod {
  STANDARD_DELIVERY
  PICKUP_FROM_STORE
}

enum AddressType {
  DELIVERY
  BILLING
  BOTH
}

enum OrderStatus {
  DRAFT
  SENT
  CONFIRMED
  PICKED_UP
  RETURNED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  CASH
}

enum PickupStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum ReturnStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum NotificationType {
  RETURN_REMINDER
  PAYMENT_CONFIRMED
  ORDER_CONFIRMED
  PICKUP_READY
  RETURN_COMPLETE
  OVERDUE_ALERT
  SYSTEM_ALERT
  GENERAL
}

enum StockMovementType {
  RESERVE
  PICKUP
  RETURN
  ADJUSTMENT
  DAMAGE
  LOSS
  CORRECTION
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  LOGIN
  LOGOUT
  PAYMENT
  CONFIG_CHANGE
}

// ====================
// MODELS
// ====================

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  passwordHash       String
  name               String
  companyName        String?
  gstin              String? // Mandatory for invoicing
  category           String? // For vendors
  role               UserRole  @default(CUSTOMER)
  isActive           Boolean   @default(true)
  credits            Int       @default(0)
  ownCouponCode      String?   @unique // Unique code for this user to share
  couponUsedAtSignup String?
  resetToken         String?
  resetExpiry        DateTime?
  deletedAt          DateTime? // Soft delete
  profilePhoto       String?   // User profile photo URL
  companyLogo        String?   // Vendor company logo URL
  bio                String?   // Short bio/description
  phone              String?   // Contact phone number

  rateLimitViolations RateLimitViolation[]
  sessions            Session[]
  analyticsEvents     AnalyticsEvent[]

  // Relations
  addresses           Address[]
  quotations          Quotation[]
  orders              RentalOrder[]        @relation("CustomerOrders")
  vendorOrders        RentalOrder[]        @relation("VendorOrders")
  invoices            Invoice[]            @relation("CustomerInvoices")
  vendorInvoices      Invoice[]            @relation("VendorInvoices")
  notifications       Notification[]
  reports             Report[]
  auditLogs           AuditLog[]
  configUpdates       SystemConfig[]
  products            Product[]            @relation("VendorProducts")
  cartItems           CartItem[]
  savedPaymentMethods SavedPaymentMethod[]

  otp                 String?
  otpExpiry           DateTime?
  isVerified          Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([gstin])
  @@index([ownCouponCode])
}

model RateLimitViolation {
  id         String  @id @default(cuid())
  identifier String // userId / IP / sessionId
  type       String // LOGIN, PAYMENT, API, GAME
  limitRule  String // "5req/5min"
  endpoint   String
  userId     String?
  ipAddress  String

  user User? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([identifier])
  @@index([type])
  @@index([createdAt])
}

model Address {
  id         String      @id @default(cuid())
  userId     String
  label      String?     // e.g., "Home", "Office"
  street     String
  city       String
  state      String
  postalCode String
  country    String      @default("India")
  type       AddressType @default(BOTH)
  isDefault  Boolean     @default(false)

  pickupOrders  RentalOrder[] @relation("OrderPickupAddress")
  returnOrders  RentalOrder[] @relation("OrderReturnAddress")
  billingOrders RentalOrder[] @relation("OrderBillingAddress")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String?
  sessionToken String   @unique
  isGuest      Boolean  @default(true)
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}

model AnalyticsDailyAggregate {
  id     String   @id @default(cuid())
  date   DateTime
  metric String // TOTAL_REVENUE, ORDERS, SIGNUPS
  value  Decimal

  @@unique([date, metric])
}

model AnalyticsEvent {
  id         String  @id @default(cuid())
  eventType  String // PAGE_VIEW, ADD_TO_CART, CHECKOUT
  userId     String?
  sessionId  String?
  entityType String? // PRODUCT, ORDER
  entityId   String?
  metadata   Json?

  user User? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([createdAt])
}

model Product {
  id              String       @id @default(cuid())
  vendorId        String?      // Which vendor owns this product (optional for migration)
  name            String
  description     String?
  sku             String       @unique
  productType     ProductType  @default(GOODS)  // GOODS or SERVICE
  category        String?      // Furniture, Electronics, etc.
  priceUnit       PriceUnit    @default(PER_DAY) // Per Hour, Day, Week, etc.
  isRentable      Boolean      @default(true)
  isPublished     Boolean      @default(false)
  costPrice       Decimal
  salePrice       Decimal
  quantityOnHand  Int
  minRentalPeriod Int          // in hours
  maxRentalPeriod Int          // in hours
  attributes      Json?        // e.g., {"brand": "Bosch", "color": "Red"}
  imageUrls       String[]
  deletedAt       DateTime?    // Soft delete

  // Relations
  vendor         User?            @relation("VendorProducts", fields: [vendorId], references: [id])
  variants       ProductVariant[]
  quotations     QuotationLine[]
  orderLines     OrderLine[]
  reservations   Reservation[]
  pickupItems    PickupItem[]
  returnItems    ReturnItem[]
  priceConfigs   PriceConfig[]
  stockMovements StockMovement[]
  cartItems      CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorId])
  @@index([sku, isRentable, isPublished])
  @@index([category])
}

model ProductVariant {
  id              String  @id @default(cuid())
  productId       String
  name            String // e.g., "Large", "Red"
  skuSuffix       String // e.g., "-L", "-RED"
  priceAdjustment Decimal // e.g., +100, -50
  quantityOnHand  Int

  quotationLines QuotationLine[]
  orderLines     OrderLine[]
  stockMovements StockMovement[]

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, name])
  @@index([productId])
}

model PriceConfig {
  id         String           @id @default(cuid())
  productId  String
  periodUnit RentalPeriodUnit
  duration   Int // e.g., 1 hour, 7 days
  price      Decimal
  isActive   Boolean          @default(true)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, periodUnit, duration])
  @@index([productId])
}

model Quotation {
  id              String      @id @default(cuid())
  customerId      String
  quotationNumber String      @unique
  status          OrderStatus @default(DRAFT)
  subtotal        Decimal
  taxAmount       Decimal
  totalAmount     Decimal
  rentalStart     DateTime
  rentalEnd       DateTime
  notes           String?

  // Relations
  customer User            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lines    QuotationLine[]
  order    RentalOrder?
  invoice  Invoice?

  createdAt DateTime @default(now())
  expiresAt DateTime // auto-set based on business rule

  @@index([customerId, status, quotationNumber])
}

enum LineType {
  RENTAL
  SALE
}

model QuotationLine {
  id          String    @id @default(cuid())
  quotationId String
  productId   String
  variantId   String?
  type        LineType  @default(RENTAL)
  quantity    Int
  unitPrice   Decimal
  lineTotal   Decimal
  rentalStart DateTime?
  rentalEnd   DateTime?

  quotation Quotation       @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([quotationId, productId])
}

model RentalOrder {
  id               String         @id @default(cuid())
  customerId       String
  vendorId         String?        // Which vendor this order belongs to (optional for migration)
  quotationId      String?        @unique
  orderNumber      String         @unique
  status           OrderStatus    @default(CONFIRMED)
  subtotal         Decimal
  taxAmount        Decimal
  totalAmount      Decimal
  securityDeposit  Decimal
  amountPaid       Decimal        @default(0)
  discountAmount   Decimal        @default(0)
  shippingAmount   Decimal        @default(0)
  downpayment      Decimal        @default(0)
  rentalStart      DateTime
  rentalEnd        DateTime
  deliveryMethod   DeliveryMethod @default(STANDARD_DELIVERY)
  pickupAddressId  String
  returnAddressId  String?
  billingAddressId String?        // Separate billing address
  billingIsSame    Boolean        @default(true) // Billing = Delivery toggle
  couponCode       String?        // Applied coupon code
  notes            String?        // Order notes
  termsAccepted    Boolean        @default(true)

  // Relations
  customer       User          @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: Cascade)
  vendor         User?         @relation("VendorOrders", fields: [vendorId], references: [id])
  quotation      Quotation?    @relation(fields: [quotationId], references: [id])
  pickupAddress  Address       @relation("OrderPickupAddress", fields: [pickupAddressId], references: [id])
  returnAddress  Address?      @relation("OrderReturnAddress", fields: [returnAddressId], references: [id])
  billingAddress Address?      @relation("OrderBillingAddress", fields: [billingAddressId], references: [id])
  lines          OrderLine[]
  invoice        Invoice?
  pickup         Pickup?
  return         Return?
  payments       Payment[]
  reservations   Reservation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId, status, orderNumber])
  @@index([vendorId])
}

model OrderLine {
  id          String    @id @default(cuid())
  orderId     String
  productId   String
  variantId   String?
  type        LineType  @default(RENTAL)
  quantity    Int
  unitPrice   Decimal
  lineTotal   Decimal
  rentalStart DateTime?
  rentalEnd   DateTime?

  order   RentalOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId, productId])
}

model Reservation {
  id        String   @id @default(cuid())
  productId String
  orderId   String
  quantity  Int
  fromDate  DateTime
  toDate    DateTime

  product Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   RentalOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([productId, orderId, fromDate, toDate])
  @@index([productId, orderId])
}

model Pickup {
  id           String       @id @default(cuid())
  orderId      String       @unique
  pickupNumber String       @unique
  pickupDate   DateTime
  instructions String?
  status       PickupStatus @default(PENDING)

  order RentalOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items PickupItem[]

  createdAt DateTime @default(now())
}

model PickupItem {
  id        String @id @default(cuid())
  pickupId  String
  productId String
  quantity  Int

  pickup  Pickup  @relation(fields: [pickupId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([pickupId, productId])
}

model Return {
  id           String       @id @default(cuid())
  orderId      String       @unique
  returnNumber String       @unique
  returnDate   DateTime
  lateDays     Int          @default(0)
  lateFee      Decimal      @default(0)
  damageFee    Decimal      @default(0)
  status       ReturnStatus @default(PENDING)

  order RentalOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items ReturnItem[]

  createdAt DateTime @default(now())
}

model ReturnItem {
  id        String @id @default(cuid())
  returnId  String
  productId String
  quantity  Int
  condition String // e.g., GOOD, DAMAGED

  return  Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([returnId, productId])
}

model StockMovement {
  id            String            @id @default(cuid())
  productId     String
  variantId     String?
  quantity      Int // Positive = add to stock, Negative = remove from stock
  movementType  StockMovementType
  referenceId   String? // orderId, pickupId, returnId, adjustmentId
  referenceType String? // ORDER, PICKUP, RETURN, ADJUSTMENT
  remarks       String?

  // Relations
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([movementType])
  @@index([referenceId])
}

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  orderId         String?       @unique
  quotationId     String?       @unique
  customerId      String
  vendorId        String?       // Which vendor this invoice belongs to (optional for migration)
  status          InvoiceStatus @default(DRAFT)
  issueDate       DateTime
  dueDate         DateTime
  subtotal        Decimal
  taxAmount       Decimal
  totalAmount     Decimal
  amountPaid      Decimal       @default(0)
  securityDeposit Decimal
  discountAmount  Decimal       @default(0)
  shippingAmount  Decimal       @default(0)
  notes           String?
  pdfUrl          String?

  // Relations
  customer  User         @relation("CustomerInvoices", fields: [customerId], references: [id], onDelete: Cascade)
  vendor    User?        @relation("VendorInvoices", fields: [vendorId], references: [id])
  order     RentalOrder? @relation(fields: [orderId], references: [id])
  quotation Quotation?   @relation(fields: [quotationId], references: [id])
  payments  Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId, status, invoiceNumber])
  @@index([vendorId])
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String?
  orderId       String?
  paymentNumber String        @unique
  amount        Decimal
  method        PaymentMethod
  transactionId String?
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?

  invoice Invoice?     @relation(fields: [invoiceId], references: [id])
  order   RentalOrder? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@index([invoiceId, orderId, status])
}

model Notification {
  id            String           @id @default(cuid())
  userId        String
  title         String
  message       String
  type          NotificationType
  isRead        Boolean          @default(false)
  isUrgent      Boolean          @default(false)
  referenceId   String?
  referenceType String?
  metadata      Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, isRead, type])
}

model Report {
  id          String @id @default(cuid())
  generatedBy String // userId
  title       String
  type        String // e.g., REVENUE, PRODUCT_PERFORMANCE
  format      String // PDF, XLSX, CSV
  url         String
  filters     Json? // {startDate, endDate, vendorId, ...}

  user User @relation(fields: [generatedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([generatedBy, type])
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String?
  userEmail    String? // Store email for deleted users
  userRole     UserRole?
  action       AuditAction
  entity       String // e.g., "PRODUCT", "ORDER", "INVOICE", "USER"
  entityId     String
  fieldChanged String? // Which field was modified
  oldValue     Json?
  newValue     Json?
  ipAddress    String?
  userAgent    String?
  metadata     Json? // Additional context

  // Optional relation (user might be deleted)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([action])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  dataType    String   @default("STRING")
  category    String   @default("GENERAL")
  description String?
  isPublic    Boolean  @default(false)

  updatedBy   String
  updatedByUser User @relation(fields: [updatedBy], references: [id])

  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([category])
}

// ====================
// ATTRIBUTE & CATEGORY CONFIGURATION
// ====================

// Attribute configurations (Brand, Color, Size, etc.)
model AttributeConfig {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Brand", "Color", "Size"
  displayName String   // Human-readable name
  values      String[] // Possible values: ["Bosch", "Makita"] or ["Red", "Blue"]
  isActive    Boolean  @default(true)
  vendorId    String?  // Null means global/admin-level
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([vendorId])
}

// Product categories
model CategoryConfig {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Furniture", "Electronics"
  displayName String
  parentId    String?  // For hierarchical categories
  isActive    Boolean  @default(true)
  
  parent      CategoryConfig?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    CategoryConfig[] @relation("CategoryHierarchy")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([parentId])
}

// Rental period templates (Daily, Hourly, Weekly, etc.)
model RentalPeriodConfig {
  id           String           @id @default(cuid())
  name         String           @unique // e.g., "Daily", "Hourly"
  periodUnit   RentalPeriodUnit
  duration     Int              // Number of units
  isActive     Boolean          @default(true)
  description  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ====================
// CART & CHECKOUT
// ====================

model CartItem {
  id            String    @id @default(cuid())
  userId        String
  productId     String
  variantId     String?
  quantity      Int       @default(1)
  rentalStart   DateTime?
  rentalEnd     DateTime?
  savedForLater Boolean   @default(false) // "Save for Later" feature
  
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, productId, variantId])
  @@index([userId])
}

// Saved payment methods for customers
model SavedPaymentMethod {
  id            String        @id @default(cuid())
  userId        String
  method        PaymentMethod
  cardLast4     String?       // Last 4 digits: "4242"
  cardBrand     String?       // "Visa", "Mastercard"
  cardExpMonth  Int?
  cardExpYear   Int?
  upiId         String?       // For UPI
  isDefault     Boolean       @default(false)
  razorpayToken String?       // Razorpay saved card token
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// Coupon codes for discounts
model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique
  description     String?
  discountType    String    // "PERCENTAGE" or "FIXED"
  discountValue   Decimal   // e.g., 10 (for 10% or â‚¹10)
  minOrderAmount  Decimal?  // Minimum order amount to apply
  maxDiscount     Decimal?  // Cap for percentage discounts
  usageLimit      Int?      // Total uses allowed
  usageCount      Int       @default(0)
  perUserLimit    Int       @default(1) // Uses per user
  validFrom       DateTime
  validUntil      DateTime
  isActive        Boolean   @default(true)
  vendorId        String?   // Vendor-specific coupon (null = global)
  
  usages CouponUsage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([code])
  @@index([vendorId])
}

model CouponUsage {
  id       String @id @default(cuid())
  couponId String
  userId   String
  orderId  String?
  
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([couponId, userId, orderId])
  @@index([userId])
}
